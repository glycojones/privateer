var CCP4Module,RDKit;function makeRequest(e,o){return new Promise((function(t,_){var c=new XMLHttpRequest;c.open(e,o,!0),c.onload=function(){this.status>=200&&this.status<300?t(c.response):_({status:this.status,statusText:c.statusText})},c.onerror=function(){_({status:this.status,statusText:c.statusText})},c.send()}))}function getLoop(e,o){let t=o+".",_=!1,c=[],m=e.length;for(let o=0;o<m;o++){let m=e[o].replace(/(^\s+|\s+$)/g,"");if("loop_"===m||"_"===m.substring(0,1)&&m.substring(0,t.length)!==t){if(_)break;o<e.length&&e[o+1].substring(0,t.length)===t&&(_=!0)}else _&&c.push(m)}return c}function splitQuotedCIFString(e){return 0===e.length?[]:e.match(/(?:[^\s"]+|"[^"]*")+/g)}function addCIFAtomTypes(e,o){let t=[],_=getLoop(o.split("\n"),"_chem_comp_atom"),c=[];for(let e=0;e<_.length;e++)if("#"!==_[e].substr(0,1)&&""!==_[e].trim())if("_"===_[e].substr(0,1))t.push(_[e]);else{let o=splitQuotedCIFString(_[e]);if("."!==o[0]){let e={};for(let _=0;_<o.length;_++)e[t[_]]=o[_];c.push(e)}}return c}function addCIFBondTypes(e,o){let t=[],_=getLoop(o.split("\n"),"_chem_comp_bond"),c=[];for(let e=0;e<_.length;e++)if("#"!==_[e].substr(0,1)&&""!==_[e].trim())if("_"===_[e].substr(0,1))t.push(_[e]);else{let o=_[e].match(/(?:[^\s"]+|"[^"]*")+/g);if("."!==o[0]){let e={};for(let _=0;_<o.length;_++)e[t[_]]=o[_];void 0!==e["_chem_comp_bond.type"]&&e["_chem_comp_bond.type"].length>0&&void 0!==e["_chem_comp_bond.comp_id"]&&e["_chem_comp_bond.comp_id"].length>0&&void 0!==e["_chem_comp_bond.atom_id_1"]&&e["_chem_comp_bond.atom_id_1"].length>0&&void 0!==e["_chem_comp_bond.atom_id_2"]&&e["_chem_comp_bond.atom_id_2"].length>0?c.push(e):void 0!==e["_chem_comp_bond.value_order"]&&e["_chem_comp_bond.value_order"].length>0&&void 0!==e["_chem_comp_bond.comp_id"]&&e["_chem_comp_bond.comp_id"].length>0&&void 0!==e["_chem_comp_bond.atom_id_1"]&&e["_chem_comp_bond.atom_id_1"].length>0&&void 0!==e["_chem_comp_bond.atom_id_2"]&&e["_chem_comp_bond.atom_id_2"].length>0&&("Y"===e["_chem_comp_bond.pdbx_aromatic_flag"]?e["_chem_comp_bond.type"]="aromatic":"SING"===e["_chem_comp_bond.value_order"]||"SINGLE"===e["_chem_comp_bond.value_order"]?e["_chem_comp_bond.type"]="single":"DOUB"===e["_chem_comp_bond.value_order"]||"DOUBLE"===e["_chem_comp_bond.value_order"]?e["_chem_comp_bond.type"]="double":"TRIP"===e["_chem_comp_bond.value_order"]||"TRIPLE"===e["_chem_comp_bond.value_order"]?e["_chem_comp_bond.type"]="triple":e["_chem_comp_bond.type"]="single",c.push(e))}}return c}function dictToMolBlock(e,o){let t=addCIFAtomTypes(e,o),_=addCIFBondTypes(e,o),c=t.length,m=_.length,n=e+"\n  CCP4-MonomerLibrary-WebToCif\n\n";n+=("  "+c).slice(-3)+("  "+m).slice(-3)+"  0  0  0  0  0  0  0  0999 V2000\n";let s=0,p="";for(let e=0;e<c;e++){let o=parseFloat(t[e]["_chem_comp_atom.x"]),_=parseFloat(t[e]["_chem_comp_atom.y"]),c=parseFloat(t[e]["_chem_comp_atom.z"]);"."!=t[e]["_chem_comp_atom.charge"]&&"0"!=t[e]["_chem_comp_atom.charge"]&&(s++,p+=("   "+(e+1)).slice(-4)+("   "+t[e]["_chem_comp_atom.charge"]).slice(-4));let m=t[e]["_chem_comp_atom.type_symbol"];n+=("          "+o.toFixed(4)).slice(-10)+("          "+_.toFixed(4)).slice(-10)+("          "+c.toFixed(4)).slice(-10)+("   "+m).slice(-3)+"   0  0  0  0  0  0  0  0  0  0  0  0\n"}for(let e=0;e<m;e++){let o=t.find((o=>o["_chem_comp_atom.atom_id"]===_[e]["_chem_comp_bond.atom_id_1"])),c=t.find((o=>o["_chem_comp_atom.atom_id"]===_[e]["_chem_comp_bond.atom_id_2"])),m=t.indexOf(o),s=t.indexOf(c),p=("  "+(m+1)).slice(-3),i=("  "+(s+1)).slice(-3),l=1;!(["_chem_comp_bond.aromatic"]in _[e])||"y_XXX"!==_[e]["_chem_comp_bond.aromatic"]&&"Y_XXX"!==_[e]["_chem_comp_bond.aromatic"]?!(["_chem_comp_bond.type"]in _[e])||"TRIPLE"!==_[e]["_chem_comp_bond.type"]&&"triple"!==_[e]["_chem_comp_bond.type"]?!(["_chem_comp_bond.type"]in _[e])||"DOUBLE"!==_[e]["_chem_comp_bond.type"]&&"double"!==_[e]["_chem_comp_bond.type"]?!(["_chem_comp_bond.type"]in _[e])||"SINGLE"!==_[e]["_chem_comp_bond.type"]&&"single"!==_[e]["_chem_comp_bond.type"]?(console.log("Unknown bond type"),console.log(_[e])):l=1:l=2:l=3:l=4,n+=p+i+("  "+l).slice(-2)+" 0  0  0  0\n"}return s>0&&(n+="M  CHG"+("   "+s).slice(-3)+p+"\n"),n+="M  END",n}importScripts("web_example.js","RDKit_minimal.js"),createCCP4Module({print(e){postMessage(["output",e])},printErr(e){postMessage(["output",e])}}).then((function(e){CCP4Module=e})).catch((e=>{console.log("CCP4 problem :("),console.log(e)})),initRDKitModule({print(e){postMessage(["output",e])},printErr(e){postMessage(["output",e])}}).then((function(e){RDKit=e})).catch((e=>{console.log("RDKit problem :("),console.log(e)})),onmessage=function(e){let o=e.data[0],t=[],_=[o],c=o,m="/monomers/"+c.toLowerCase()[0]+"/"+c.toUpperCase()+".cif";t.push(makeRequest("GET",m,!0));let n={};t.length>0&&Promise.all(t).then((e=>{let o=_[0],t=dictToMolBlock(o,e[0]),c=RDKit.get_mol(t),m=RDKit.get_mol(c.remove_hs()).get_smiles(),s=RDKit.get_mol(m);n[o]=s.get_svg(),postMessage(["result",n])})).catch((e=>{console.error(e),postMessage(["result",n])}))};